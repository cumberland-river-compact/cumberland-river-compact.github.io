<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
    crossorigin="anonymous">
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css?family=EB+Garamond" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.10/css/all.css" integrity="sha384-+d0P83n9kaQMCwj8F4RJB66tzIwOKmrdb46+porD/OvrJ+37WqIM7UoBtwHO6Nlg"
    crossorigin="anonymous">
  <!-- Calcite Maps Bootstrap -->
  <link rel="stylesheet" href="https://esri.github.io/calcite-maps/dist/css/calcite-maps-bootstrap.min-v0.7.css">
  <!-- Calcite Maps -->
  <link rel="stylesheet" href="https://esri.github.io/calcite-maps/dist/css/calcite-maps-arcgis-4.x.min-v0.7.css">
  <!-- ArcGIS JS 4 -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.7/esri/css/main.css">
  <!-- Keep ours last to override the rest -->
  <link rel="stylesheet" href="main.css">

  <title>Welcome to iCreek</title>
</head>

<body class="calcite-maps calcite-nav-top">
  <!-- Navbar -->

  <nav class="navbar calcite-navbar navbar-fixed-top calcite-text-light calcite-bg-dark">
    <!-- Menu -->
    <div class="dropdown calcite-dropdown calcite-text-dark calcite-bg-light" role="presentation">
      <a class="dropdown-toggle" role="menubutton" aria-haspopup="true" aria-expanded="false" tabindex="0">
        <div class="calcite-dropdown-toggle">
          <span class="sr-only">Toggle dropdown menu</span>
          <span></span>
          <span></span>
          <span></span>
          <span></span>
        </div>
      </a>
      <ul class="dropdown-menu" role="menu">
        <li>
          <a role="menuitem" tabindex="0" data-target="#panelInfo" aria-haspopup="true">
            <span class="glyphicon glyphicon-info-sign"></span> About</a>
        </li>
        <li>
          <a role="menuitem" tabindex="0" href="#" data-target="#panelLegend" aria-haspopup="true">
            <span class="glyphicon glyphicon-list-alt"></span> Legend</a>
        </li>
        <li>
          <a role="menuitem" tabindex="0" href="#" id="calciteToggleNavbar" aria-haspopup="true">
            <span class="glyphicon glyphicon-fullscreen"></span> Full Map</a>
        </li>
      </ul>
    </div>
    <!-- Title -->
    <div class="calcite-title calcite-overflow-hidden">
        <img src="assets/icreek_logo.png" class="img-fluid" id= "icreek-logo" alt="Responsive image">
      <span class="calcite-title-divider hidden-xs"></span>
      <span class="calcite-title-sub hidden-xs">How Healthy is Your Waterway?</span>
    </div>
    <!-- Nav -->
    <ul class="nav navbar-nav calcite-nav">
      <li>
        <!-- <div class="calcite-navbar-search calcite-search-expander"> -->
        <div id="searchWidgetDiv"></div>
        <!-- </div> -->
      </li>
    </ul>
  </nav>

  <!--/.calcite-navbar -->

  <!-- Map  -->

  <div class="calcite-map calcite-map-absolute">
    <div id="mapViewDiv">
      <div id="outputMessages">
          
      </div>
    </div>
  </div>

  <!-- /.calcite-map -->

  <!-- Panels -->

  <div class="calcite-panels calcite-panels-right calcite-text-light calcite-bg-dark panel-group">

    <!-- Panel - Basemaps -->


    <div id="panelInfo" class="panel collapse in">
      <div id="headingInfo" class="panel-heading" role="tab">
        <div class="panel-title">
          <a class="panel-toggle" role="button" data-toggle="collapse" href="#collapseInfo" aria-expanded="true" aria-controls="collapseInfo">
            <span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span>
            <span class="panel-label">About</span>
          </a>
          <a class="panel-close" role="button" data-toggle="collapse" tabindex="0" href="#panelInfo">
            <span class="esri-icon esri-icon-close" aria-hidden="true"></span>
          </a>
        </div>
      </div>
      <div id="collapseInfo" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="headingInfo">
        <div class="panel-body">
          <p>This is my map app!</p>
        </div>
      </div>
    </div>

    <!-- Panel - Legend -->

    <div id="panelLegend" class="panel collapse">
      <div id="headingLegend" class="panel-heading" role="tab">
        <div class="panel-title">
          <a class="panel-toggle" role="button" data-toggle="collapse" href="#collapseLegend" aria-expanded="false" aria-controls="collapseLegend">
            <span class="glyphicon glyphicon-list-alt" aria-hidden="true"></span>
            <span class="panel-label">Legend</span>
          </a>
          <a class="panel-close" role="button" data-toggle="collapse" tabindex="0" href="#panelLegend">
            <span class="esri-icon esri-icon-close" aria-hidden="true"></span>
          </a>
        </div>
      </div>
      <div id="collapseLegend" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingLegend">
        <div class="panel-body">
          <div id="legendDiv"></div>
        </div>
      </div>
    </div>

  </div>

  <script type="text/javascript">
    var dojoConfig = {
      packages: [{
        name: "bootstrap",
        location: "https://esri.github.io/calcite-maps/dist/vendor/dojo-bootstrap"
      },
      {
        name: "calcite-maps",
        location: "https://esri.github.io/calcite-maps/dist/js/dojo"
      }]
    };
  </script>

  <!-- ArcGIS JS 4 -->
  <script src="https://js.arcgis.com/4.6/"></script>

  <script>
    require([
      // ArcGIS
      'esri/Map',
      'esri/WebMap',
      'esri/views/MapView',

      // Widgets
      // TODO: Remove what we don't use...
      'esri/widgets/Home',
      'esri/widgets/Zoom',
      'esri/widgets/Compass',
      'esri/widgets/Search',
      'esri/widgets/Legend',
      'esri/widgets/BasemapToggle',
      'esri/widgets/ScaleBar',
      'esri/widgets/Attribution',

      // Tasks
      'esri/tasks/IdentifyTask',
      'esri/tasks/support/IdentifyParameters',

      // Bootstrap
      'bootstrap/Collapse',
      'bootstrap/Dropdown',

      // Calcite Maps
      'calcite-maps/calcitemaps-v0.7',
      // Calcite Maps ArcGIS Support
      'calcite-maps/calcitemaps-arcgis-support-v0.7',

      'dojo/domReady!',
    ], function (
      Map,
      WebMap,
      MapView,
      Home,
      Zoom,
      Compass,
      Search,
      Legend,
      BasemapToggle,
      ScaleBar,
      Attribution,
      IdentifyTask,
      IdentifyParameters,
      Collapse,
      Dropdown,
      CalciteMaps,
      CalciteMapArcGISSupport
    ) {
        var identifyTask, params;

        // TODO: Can we get this URL from the map or the layer's ArcGIS content ID?
        var drainageAreasUrl =
          'https://watersgeo.epa.gov/arcgis/rest/services/NHDPlus_NP21/Catchments_NP21_Simplified/MapServer';

        // Map
        var map = new WebMap({
          portalItem: {
            // id: '9f91f911f58540ceaac0300c55e18fbb', // Just a random map for testing
            id: '505bc0a0a0cf450e9b40658672ce16be',
          },
        });

        // View
        var mapView = new MapView({
          container: 'mapViewDiv',
          map: map,
          padding: {
            // Use the same value as #header-img height
            top: 395,
            bottom: 10,
            right: 10,
            left: 10,
          },
          ui: { components: [] },
        });

        mapView.when(function () {
          console.log('when!');
          // Create an identify task to locate boundaries
          identifyTask = new IdentifyTask(drainageAreasUrl);
          params = new IdentifyParameters();
          params.tolerance = 1;
          params.layerIds = [0]; // This map service's layer is found by ID
          params.layerOption = 'top';
          params.width = mapView.width;
          params.height = mapView.height;
        });

        // Popup and panel sync
        mapView.when(function () {
          CalciteMapArcGISSupport.setPopupPanelSync(mapView);
        });

        var searchWidget = new Search({
          container: 'searchWidgetDiv',
          view: mapView,
          // allPlaceholder: 'Find an address or place',
          locationEnabled: true,
          maxSuggestions: 3,
          minSuggestCharacters: 2,
          maxResults: 1,
          searchAllEnabled: false,
        });
        // CalciteMapArcGISSupport.setSearchExpandEvents(searchWidget);

        searchWidget.on('search-clear', function (event) {
          console.log('Search input textbox was cleared.');
        });

        searchWidget.on('search-complete', function (event) {
          // The results are stored in the event Object[]
          console.log('Results of the search: ', event);
          if (event.results) {
            var result = event.results[0].results[0];
            console.log('Name: ', result.name);
            console.log('Location: ', result.feature);

            // Set the geocode result as input to our Identity Task
            params.geometry = result.feature.geometry;
            params.mapExtent = mapView.extent; // TODO: Expand the search!

            // TODO: Show a wait cursor or spinner
            // dom.byId('mapViewDiv').style.cursor = 'wait';

            // This function returns a promise that resolves to an array of features
            identifyTask
              .execute(params)
              .then(function (response) {
                var results = response.results;
                if (results[0]) {
                  var drainageArea = results[0];
                  var feature = drainageArea.feature;
                  var layerName = drainageArea.layerName;
                  feature.attributes.layerName = layerName;
                  feature.popupTemplate = {
                    // autocasts as new PopupTemplate()
                    title: 'Title 123',
                    content: 'Content 345',
                  };
                  return feature;
                }

                // return arrayUtils.map(results, function(result) {
                //   var feature = result.feature;
                //   var layerName = result.layerName;
                //   feature.attributes.layerName = layerName;
                //   if (layerName === 'Soil Survey Geographic') {
                //     feature.popupTemplate = { // autocasts as new PopupTemplate()
                //       title: "{Map Unit Name}",
                //       content: "<b>Dominant order:</b> {Dominant Order} ({Dom. Cond. Order %}%)" +
                //         "<br><b>Farmland Class:</b> {Farmland Class}"
                //     };
                //   }
                //   return feature;
                // });
              })
              .then(showPopup);

            // Shows the results of the Identify in a popup once the promise is resolved
            function showPopup(feature) {
              if (feature) {
                mapView.popup.open({
                  features: [feature],
                  location: mapView.center, // TODO: use correct location
                });
              }
              // TODO: Disable the wait cursor and/or spinner
              // dom.byId('mapViewDiv').style.cursor = 'auto';
            }
          }
        });
        // Map widgets
        // var home = new Home({
        //   view: mapView
        // });
        // mapView.ui.add(home, "top-left");

        var zoom = new Zoom({
          view: mapView,
        });
        mapView.ui.add(zoom, 'bottom-left');

        // var compass = new Compass({
        //   view: mapView
        // });
        // mapView.ui.add(compass, "top-left");

        var basemapToggle = new BasemapToggle({
          view: mapView,
          nextBasemap: 'satellite',
          // nextBasemap: "streets-relief-vector"
        });
        mapView.ui.add(basemapToggle, 'bottom-right');

        // var scaleBar = new ScaleBar({
        //   view: mapView
        // });
        // mapView.ui.add(scaleBar, "bottom-left");

        var attribution = new Attribution({
          view: mapView,
        });
        mapView.ui.add(attribution, 'manual');

        // Panel widgets - add legend
        // var legendWidget = new Legend({
        //   container: 'legendDiv',
        //   view: mapView,
        // });
      });
  </script>

  <!-- <div class="col-md"> -->
  <!--   <div id="waterway-info"></div> -->
  <!-- </div> -->
  <!-- <div class="col-md"> -->
  <!--     <div id="map"></div> -->
  <!-- </div> -->

  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
    crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
    crossorigin="anonymous"></script>
  <!-- <script src="main.js"></script> -->
</body>

</html>
